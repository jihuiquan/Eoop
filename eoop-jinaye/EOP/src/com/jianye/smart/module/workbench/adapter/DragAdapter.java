package com.jianye.smart.module.workbench.adapter;import android.content.Context;import android.content.Intent;import android.content.pm.PackageManager;import android.graphics.Bitmap;import android.graphics.BitmapFactory;import android.os.Handler;import android.support.v4.view.PagerAdapter;import android.support.v4.view.ViewPager;import android.text.TextUtils;import android.util.Log;import android.util.Patterns;import android.view.LayoutInflater;import android.view.View;import android.view.View.OnClickListener;import android.view.ViewGroup;import android.widget.BaseAdapter;import android.widget.ImageView;import android.widget.TextView;import com.androidquery.AQuery;import com.androidquery.callback.AjaxStatus;import com.androidquery.callback.BitmapAjaxCallback;import com.movit.platform.common.application.BaseApplication;import com.movit.platform.common.constants.CommConstants;import com.movit.platform.common.okhttp.OkHttpUtils;import com.movit.platform.common.okhttp.callback.StringCallback;import com.movit.platform.framework.utils.PicUtils;import com.movit.platform.framework.utils.SharedPreUtils;import com.movit.platform.framework.view.pageIndicator.CirclePageIndicator;import com.jianye.smart.R;import com.jianye.smart.module.workbench.activity.WebViewActivity;import com.jianye.smart.module.workbench.constants.Constants;import com.jianye.smart.module.workbench.model.Banner;import com.jianye.smart.module.workbench.model.WorkTable;import com.jianye.smart.view.DragGridViewPage;import com.jianye.smart.view.DragGridViewPage.DragGridBaseAdapter;import com.jianye.smart.view.DragGridViewPage.onItemDelectAndSwapCallback;import org.json.JSONArray;import org.json.JSONException;import org.json.JSONObject;import java.io.File;import java.util.ArrayList;import java.util.Collections;import java.util.List;import java.util.Map;import okhttp3.Call;/** * @author xiaanming * @blog http://blog.csdn.net/xiaanming */public class DragAdapter extends BaseAdapter implements DragGridBaseAdapter {    private List<WorkTable> list;    private LayoutInflater mInflater;    private int mHidePosition = -1;    Context context;    Handler handler;    private int mFinallyPosition = -1;    private int mDragedPosition = -1;    DragGridViewPage dragGridViewPage;    ArrayList<WorkTable> allList = new ArrayList<WorkTable>();    private List<WorkTable> addList = new ArrayList<WorkTable>();    String tag;    AQuery aq;    boolean isShowDel = false;    List<Banner> banners = new ArrayList<Banner>();    List<Bitmap> imageBitmaps = new ArrayList<Bitmap>();    SharedPreUtils spUtil;    /**     * ViewPager     */    private ViewPager viewPager;    private TopNewsAdapter topNewsAdapter;    private ArrayList<View> mListViews;    private LayoutInflater inflater;    public DragAdapter(Context context, List<WorkTable> list,                       DragGridViewPage dragGridViewPage, Handler handler, String tag) {        this.list = list;        mInflater = LayoutInflater.from(context);        this.context = context;        this.handler = handler;        this.dragGridViewPage = dragGridViewPage;        this.tag = tag;        aq = new AQuery(context);        spUtil = new SharedPreUtils(context);        reSetData();    }    private Map<String, Integer> unReadNums;    public void setUnreadNums(Map<String, Integer> unReadNums) {        this.unReadNums = unReadNums;    }    public void reSetData() {        allList.clear();        addList.clear();        if (null != list) {            if (dragGridViewPage.ismCustomerEnable()) {                if (list.size() < dragGridViewPage.getCustomerPostion()) {                    for (int i = list.size(); i < dragGridViewPage.getCustomerPostion(); i++) {                        addList.add(new WorkTable());                    }                }                allList.addAll(list);                allList.addAll(addList);                allList.add(dragGridViewPage.getCustomerPostion(), new WorkTable());                if (list.size() > dragGridViewPage.getCustomerPostion()) {                    dragGridViewPage.setAvalableChildCount(list.size() + 1);                } else {                    dragGridViewPage.setAvalableChildCount(list.size());                }            } else {                allList.addAll(list);                dragGridViewPage.setAvalableChildCount(list.size());            }        }    }    @Override    public int getCount() {        return allList.size();    }    @Override    public Object getItem(int position) {        return allList.get(position);    }    @Override    public long getItemId(int position) {        return position;    }    /**     * 由于复用convertView导致某些item消失了，所以这里不复用item，     */    @Override    public View getView(final int position, View convertView, ViewGroup parent) {        if (convertView == null) {            if (position == dragGridViewPage.getCustomerPostion()) {                convertView = mInflater.inflate(R.layout.work_table_viewpage, null);            } else {                convertView = mInflater.inflate(                        R.layout.work_table_gridview_item, null);            }        }        convertView.setVisibility(View.VISIBLE);        final WorkTable table = allList.get(position);        AQuery aQuery = aq.recycle(convertView);        if (position != dragGridViewPage.getCustomerPostion()) {            final TextView name = (TextView) convertView                    .findViewById(R.id.gridview_item_name);            final ImageView photo = (ImageView) convertView                    .findViewById(R.id.gridview_item_img);            ImageView delImg = (ImageView) convertView                    .findViewById(R.id.gridview_item_delImg);            //增加未读数提醒            TextView redDian = (TextView) convertView                    .findViewById(R.id.gridview_item_dian);            if (null != unReadNums && unReadNums.size() > 0 && unReadNums.containsKey(table.getAndroid_access_url()) && unReadNums.get(table.getAndroid_access_url()) > 0) {                if (unReadNums.get(table.getAndroid_access_url()) > 99) {                    redDian.setText("99+");                } else {                    redDian.setText("" + unReadNums.get(table.getAndroid_access_url()));                }                redDian.setVisibility(View.VISIBLE);            } else {                redDian.setVisibility(View.GONE);            }            if (tag.equals("add")) {                delImg.setImageResource(R.drawable.icon_add_2);            } else if (tag.equals("del")) {                delImg.setImageResource(R.drawable.icon_del);            }            if (!TextUtils.isEmpty(table.getId())) {                delImg.setVisibility(View.INVISIBLE);                delImg.setOnClickListener(new OnClickListener() {                    @Override                    public void onClick(View v) {                        clearDrag();                        dragGridViewPage.onItemDelectAndSwap(position,                                dragGridViewPage.getAvalableChildCount() - 1,                                new onItemDelectAndSwapCallback() {                                    @Override                                    public void swapDone() {                                        if (tag.equals("del")) {                                            dragGridViewPage                                                    .setOnItemDelectAndSwapCallback(null);                                            list.remove(table);                                            reSetData();                                            notifyDataSetChanged();                                            handler.obtainMessage(33, table)                                                    .sendToTarget();                                        } else if (tag.equals("add")) {                                            dragGridViewPage                                                    .setOnItemDelectAndSwapCallback(null);                                            list.remove(table);                                            reSetData();                                            notifyDataSetChanged();                                            handler.obtainMessage(33, table)                                                    .sendToTarget();                                        }                                    }                                });                    }                });                if (table.getId().equals("more")) {                    name.setText("更多");                    if (!"default".equals(spUtil                            .getString(BaseApplication.SKINTYPE))) {                        String skinType = spUtil                                .getString(BaseApplication.SKINTYPE);                        File dir = context                                .getDir("theme", Context.MODE_PRIVATE);                        File skinDir = new File(dir, skinType);                        Bitmap bitmap = BitmapFactory.decodeFile(skinDir                                + "/ico_more.png");                        photo.setImageBitmap(bitmap);                    } else {                        photo.setImageResource(R.drawable.ico_more);                    }                } else {                    name.setText(table.getName());                    BitmapAjaxCallback callback = new BitmapAjaxCallback() {                        @Override                        protected void callback(String url, ImageView iv,                                                Bitmap bm, AjaxStatus status) {                            if (Constants.STATUS_UNAVAILABLE.equals(table.getStatus())) {                                try {                                    Bitmap gray = PicUtils.bitmap2Gray(bm);                                    iv.setImageBitmap(gray);                                } catch (Exception e) {                                    e.printStackTrace();                                }                            } else {                                super.callback(url, iv, bm, status);                            }                        }                    };                    callback.animation(AQuery.FADE_IN_NETWORK);                    aQuery.id(photo).image(CommConstants.URL_DOWN + table.getPicture(), true, true, 0, R.drawable.zone_pic_default, callback);                }            } else {                convertView.setVisibility(View.INVISIBLE);            }        } else {            if (banners.isEmpty())                initViewPage(convertView);        }        if (position == mHidePosition && position != dragGridViewPage.getCustomerPostion()) {            convertView.setVisibility(View.INVISIBLE);        }        return convertView;    }    private void initViewPage(View convertView) {        inflater = LayoutInflater.from(context);        viewPager = (ViewPager) convertView.findViewById(R.id.view_pager);        CirclePageIndicator mIndicator = (CirclePageIndicator) convertView.findViewById(R.id.indicator);        mListViews = new ArrayList<View>();        topNewsAdapter = new TopNewsAdapter(context, banners                , mListViews);        viewPager.setAdapter(topNewsAdapter);        viewPager.setCurrentItem(1);        if (!"default".equals(spUtil.getString(BaseApplication.SKINTYPE))) {            String skinType = spUtil.getString(BaseApplication.SKINTYPE);            File dir = context.getDir("theme", Context.MODE_PRIVATE);            File skinDir = new File(dir, skinType);            if (skinDir.isDirectory()) {                File files[] = skinDir.listFiles();                for (int i = 0; i < files.length; i++) {                    if (files[i].getName().contains("view_pager_screen")) {                        Bitmap bitmap = BitmapFactory.decodeFile(files[i].getAbsolutePath());//                        imageUrls.add(i);                        imageBitmaps.add(bitmap);                    }                }            }        } else {            String type = "";            try {                type = context.getPackageManager().getApplicationInfo(context.getPackageName(),                        PackageManager.GET_META_DATA).metaData                        .getString("CHANNEL_TYPE");            } catch (PackageManager.NameNotFoundException e) {                e.printStackTrace();            }            OkHttpUtils                    .get()                    .url(CommConstants.URL_BANNER_PICTURE)                    .build()                    .execute(new StringCallback() {                        @Override                        public void onError(Call call, Exception e) {                            Log.e(CommConstants.LogTag, "getBanners 请求错误:" + e.getMessage());                        }                        @Override                        public void onResponse(String response) throws JSONException {                            Log.d(CommConstants.URL_BANNER_PICTURE, "getBanners:" + response);                            JSONObject jsonObject = new JSONObject(response);                            JSONArray objValue = jsonObject.getJSONArray("objValue");                            mListViews.clear();                            banners.clear();                            for (int i = 0; i < objValue.length(); i++) {                                JSONObject obj = objValue.getJSONObject(i);                                Banner banner = new Banner();                                banner.setId(obj.optString("id"));                                banner.setLink(obj.optString("link"));                                banner.setPicurl(obj.optString("picurl"));                                banners.add(banner);                                View view = inflater.inflate(R.layout.work_table_view_page_item, null);                                mListViews.add(view);                            }                            topNewsAdapter.notifyDataSetChanged();                        }                    });        }        mIndicator.setViewPager(viewPager);        mHandler.postDelayed(new BannerChange(), 5000);    }    Handler mHandler = new Handler();    class BannerChange implements Runnable {        @Override        public void run() {            try {                int k = viewPager.getCurrentItem();                int next = (k + 1) % banners.size();                viewPager.setCurrentItem(next, true);            } catch (Exception e) {                e.printStackTrace();            }            mHandler.postDelayed(this, 5000);        }    }    public boolean isShowDel() {        return isShowDel;    }    @Override    public void reorderItems(int oldPosition, int newPosition) {        WorkTable temp = allList.get(oldPosition);        if (oldPosition < newPosition) {            for (int i = oldPosition; i < newPosition; i++) {                if (i == dragGridViewPage.getCustomerPostion()) {                    continue;                }                if (i == dragGridViewPage.getCustomerPostion() - 1) {                    Collections.swap(allList, i, i + 2);                } else {                    Collections.swap(allList, i, i + 1);                }            }        } else if (oldPosition > newPosition) {            for (int i = oldPosition; i > newPosition; i--) {                if (i == dragGridViewPage.getCustomerPostion()) {                    continue;                }                if (i == dragGridViewPage.getCustomerPostion() + 1) {                    Collections.swap(allList, i, i - 2);                } else {                    Collections.swap(allList, i, i - 1);                }            }        }        allList.set(newPosition, temp);        mFinallyPosition = newPosition;        if (oldPosition > dragGridViewPage.getCustomerPostion()) {            oldPosition -= 1;        }        if (newPosition > dragGridViewPage.getCustomerPostion()) {            newPosition -= 1;        }        WorkTable myTemp = list.get(oldPosition);        if (oldPosition < newPosition) {            for (int i = oldPosition; i < newPosition; i++) {                Collections.swap(list, i, i + 1);            }        } else if (oldPosition > newPosition) {            for (int i = oldPosition; i > newPosition; i--) {                Collections.swap(list, i, i - 1);            }        }        list.set(newPosition, myTemp);    }    @Override    public void setHideItem(int hidePosition) {        this.mHidePosition = hidePosition;        notifyDataSetChanged();    }    @Override    public void startDrag(View view, int postion) {        if (isShowDel) {            if (postion != mFinallyPosition) {                View show = dragGridViewPage.getChildAt(mFinallyPosition);                ImageView flag = (ImageView) show                        .findViewById(R.id.gridview_item_delImg);                flag.setVisibility(View.INVISIBLE);                show.setBackgroundResource(R.drawable.grid_item_selector);            }        }        view.setBackgroundResource(R.drawable.grid_item_selector);        ImageView flag = (ImageView) view.findViewById(R.id.gridview_item_delImg);        flag.setVisibility(View.VISIBLE);        mDragedPosition = postion;        mFinallyPosition = postion;        isShowDel = true;    }    @Override    public void stopDrag() {        View view = dragGridViewPage.getChildAt(mFinallyPosition);        View startView = dragGridViewPage.getChildAt(mDragedPosition);        startView.setBackgroundResource(R.drawable.grid_item_selector);        view.setBackgroundResource(R.drawable.grid_item_selector);        ImageView flag = (ImageView) view                .findViewById(R.id.gridview_item_delImg);        if (mDragedPosition == mFinallyPosition) {            if (mFinallyPosition != dragGridViewPage.getCustomerPostion()) {                flag.setVisibility(View.VISIBLE);                view.setBackgroundColor(0xfff0f0f0);            }        } else {            if (mFinallyPosition != dragGridViewPage.getCustomerPostion()) {                flag.setVisibility(View.INVISIBLE);                isShowDel = false;                handler.obtainMessage(34).sendToTarget();            }        }    }    @Override    public void clearDrag() {        if (mFinallyPosition != -1                && mFinallyPosition != dragGridViewPage.getCustomerPostion()) {            View view = dragGridViewPage.getChildAt(mFinallyPosition);            if (view != null) {                ImageView flag = (ImageView) view                        .findViewById(R.id.gridview_item_delImg);                view.setBackgroundResource(R.drawable.grid_item_selector);                if (flag != null) {                    flag.setVisibility(View.INVISIBLE);                }            }            isShowDel = false;        }        notifyDataSetChanged();    }    class TopNewsAdapter extends PagerAdapter {        private List<Banner> banners;        private List<View> mListViews;        private AQuery aQuery;        public TopNewsAdapter(Context mContext, List<Banner> banners,                              List<View> mListViews) {            super();            this.banners = banners;            this.mListViews = mListViews;            aQuery = new AQuery(context);        }        @Override        public void destroyItem(ViewGroup container, int position, Object object) {            container.removeView(mListViews.get(position));// 删除页卡        }        @Override        public int getCount() {            return mListViews.size();// 返回页卡的数量        }        @Override        public boolean isViewFromObject(View arg0, Object arg1) {            return arg0 == arg1;// 官方提示这样写        }        @Override        public Object instantiateItem(ViewGroup container, final int position) {            container.addView(mListViews.get(position), 0);// 添加页卡            ImageView view = (ImageView) mListViews.get(position);            view.setScaleType(ImageView.ScaleType.FIT_XY);            if (!"default".equals(spUtil.getString(BaseApplication.SKINTYPE))) {                view.setImageBitmap(imageBitmaps.get(position));            } else {                aQuery.id(view).image(CommConstants.URL_DOWN + banners.get(position).getPicurl(), false,                        true, 512, R.drawable.zone_banner_bg);            }            if (Patterns.WEB_URL.matcher(banners.get(position).getLink()).matches()) {                view.setOnClickListener(new OnClickListener() {                    @Override                    public void onClick(View view) {                        Intent intent = new Intent(context,                                WebViewActivity.class);                        intent.putExtra("URL", banners.get(position).getLink());                        intent.putExtra("FutureLand", false);                        intent.putExtra("WebViewFuncion", true);                        intent.putExtra("local_html", true);                        context.startActivity(intent);                    }                });            }            return mListViews.get(position);        }    }}